name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ“ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
            cd ~/musicBot

            echo "ðŸ”„ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° pull Ð±ÐµÐ· rebase"
            git config pull.rebase false

            echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
            git pull origin main

            echo "ðŸ ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ"
            source /opt/qobuz-env/bin/activate

            echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
            pip install -r requirements.txt

            echo "ðŸ§¼ Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð±Ð¾Ñ‚Ð° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)"
            pkill -f music_bot.py || echo "ÐÐµÑ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° â€” Ð²ÑÑ‘ Ñ‡Ð¸ÑÑ‚Ð¾"

            echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð±Ð¾Ñ‚Ð°"
            nohup /opt/qobuz-env/bin/python3 music_bot.py > bot.log 2>&1 &