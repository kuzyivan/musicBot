name: üöÄ Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v3

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            APP_DIR="/root/musicBot"  # <--- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1
            
            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            mkdir -p "$APP_DIR"
            
            cd "$APP_DIR"

            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            git config --global --add safe.directory "$APP_DIR"
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "ü§´ –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤..."
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
            echo "QOBUZ_LOGIN=${{ secrets.QOBUZ_LOGIN }}" >> .env
            echo "QOBUZ_PASSWORD=${{ secrets.QOBUZ_PASSWORD }}" >> .env
            echo "AUDD_API_TOKEN=${{ secrets.AUDD_API_TOKEN }}" >> .env
            echo "SPOTIPY_CLIENT_ID=${{ secrets.SPOTIPY_CLIENT_ID }}" >> .env
            echo "SPOTIPY_CLIENT_SECRET=${{ secrets.SPOTIPY_CLIENT_SECRET }}" >> .env
            echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω."

            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï QOBUZ (–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–£–¢–¨ –î–õ–Ø ROOT) ---
            echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Qobuz..."
            
            # 1. –£–±–∏—Ä–∞–µ–º –∑–∞—â–∏—Ç—É —Å–æ —Å—Ç–∞—Ä—ã—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            chattr -i "/opt/musicBot/home/.config/qobuz-dl/config.ini" || true
            chattr -i "/opt/musicBot/home/.config/qobuz-dl" || true
            chattr -i "/home/musicbot/.config/qobuz-dl/config.ini" || true
            chattr -i "/home/musicbot/.config/qobuz-dl" || true

            # 2. –£–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–æ–º–∞—à–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ROOT
            QOBUZ_CONFIG_DIR="/root/.config/qobuz-dl" # <--- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2
            QOBUZ_CONFIG_FILE="$QOBUZ_CONFIG_DIR/config.ini"
            
            mkdir -p "$QOBUZ_CONFIG_DIR"
            
            cat > "$QOBUZ_CONFIG_FILE" <<- EOF
            [DEFAULT]
            email = ${{ secrets.QOBUZ_LOGIN }}
            password = ${{ secrets.QOBUZ_PASSWORD }}
            default_folder =
            default_quality = 27
            default_limit = none
            no_m3u = true
            EOF
            
            echo "‚úÖ config.ini –¥–ª—è Qobuz —Å–æ–∑–¥–∞–Ω –≤ /root/.config/."
            # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø QOBUZ ---

            echo "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            if [ ! -d "venv" ]; then
              python3.11 -m venv venv
            fi
            source venv/bin/activate

            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ YouTube –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤..."
            pip uninstall -y youtube-dl yt-dlp yt-dlp-compat-youtube-dl
            pip install -U youtube-dl
            pip install -U yt-dlp

            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
            mkdir -p logs
            mkdir -p Qobuz/Downloads
            
            # –ö–æ–º–∞–Ω–¥–∞ chown -R musicbot:musicbot "$APP_DIR" –£–î–ê–õ–ï–ù–ê, 
            # —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç root –∏ –ø–∞–ø–∫–∞ /root/musicBot 
            # –∏ —Ç–∞–∫ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç root.

            echo "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ musicbot..."
            systemctl daemon-reload
            systemctl restart musicbot.service

            echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"