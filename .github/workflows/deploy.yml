name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            APP_DIR="/opt/musicBot"
            
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚..."
            mkdir -p "$APP_DIR"
            
            cd "$APP_DIR"

            # --- Ð Ð•Ð¨Ð•ÐÐ˜Ð• ÐŸÐ ÐžÐ‘Ð›Ð•ÐœÐ« Ð¡ "DUBIOUS OWNERSHIP" ---
            git config --global --add safe.directory "$APP_DIR"
            
            echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "ðŸ¤« Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²..."
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
            echo "QOBUZ_LOGIN=${{ secrets.QOBUZ_LOGIN }}" >> .env
            echo "QOBUZ_PASSWORD=${{ secrets.QOBUZ_PASSWORD }}" >> .env
            echo "AUDD_API_TOKEN=${{ secrets.AUDD_API_TOKEN }}" >> .env
            echo "SPOTIPY_CLIENT_ID=${{ secrets.SPOTIPY_CLIENT_ID }}" >> .env
            echo "SPOTIPY_CLIENT_SECRET=${{ secrets.SPOTIPY_CLIENT_SECRET }}" >> .env
            echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½."

            # --- Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• QOBUZ (ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð™ ÐŸÐ£Ð¢Ð¬) ---
            echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Qobuz..."

            # 1. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑƒÐ±ÐµÑ€ÐµÐ¼ Ð·Ð°Ñ‰Ð¸Ñ‚Ñƒ ÑÐ¾ Ð¡Ð¢ÐÐ ÐžÐ“Ðž, ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ“Ðž Ñ„Ð°Ð¹Ð»Ð° (Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ðµ Ð¿Ð°Ð´Ð°Ð»)
            echo "ðŸ”“ Ð¡Ð½ÑÑ‚Ð¸Ðµ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ (Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð° immutable) ÑÐ¾ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°..."
            chattr -i "/opt/musicBot/home/.config/qobuz-dl/config.ini" || true
            chattr -i "/opt/musicBot/home/.config/qobuz-dl" || true
            
            # 2. Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð° Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð´Ð¾Ð¼Ð°ÑˆÐ½Ð¸Ð¹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ musicbot
            QOBUZ_CONFIG_DIR="/home/musicbot/.config/qobuz-dl"
            QOBUZ_CONFIG_FILE="$QOBUZ_CONFIG_DIR/config.ini"
            
            # 3. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            mkdir -p "$QOBUZ_CONFIG_DIR"
            
            # 4. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ config.ini
            cat > "$QOBUZ_CONFIG_FILE" <<- EOF
            [DEFAULT]
            email = ${{ secrets.QOBUZ_LOGIN }}
            password = ${{ secrets.QOBUZ_PASSWORD }}
            default_folder =
            default_quality = 27
            default_limit = none
            no_m3u = true
            EOF
            
            # 5. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð½Ð¾Ð²ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ (chown Ð² ÐºÐ¾Ð½Ñ†Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° ÐµÐµ Ð½Ðµ Ð·Ð°Ñ†ÐµÐ¿Ð¸Ñ‚)
            chown -R musicbot:musicbot "$QOBUZ_CONFIG_DIR"
            
            echo "âœ… config.ini Ð´Ð»Ñ Qobuz ÑÐ¾Ð·Ð´Ð°Ð½ Ð² /home/musicbot/."
            # --- ÐšÐžÐÐ•Ð¦ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ QOBUZ ---

            echo "ðŸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
            if [ ! -d "venv" ]; then
              python3.11 -m venv venv
            fi
            source venv/bin/activate

            echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Python..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # --- Ð¤Ð˜ÐÐÐ›Ð¬ÐÐžÐ• Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• SAVIFY (ÐžÐ¡Ð¢ÐÐ’Ð›Ð¯Ð•Ðœ) ---
            echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° YouTube Ð·Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸ÐºÐ¾Ð²..."
            pip uninstall -y youtube-dl yt-dlp yt-dlp-compat-youtube-dl
            
            # 1. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ youtube-dl (ÑÑ‚Ð°Ñ€Ñ‹Ð¹, Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð°)
            pip install -U youtube-dl
            
            # 2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ yt-dlp (Ð½Ð¾Ð²Ñ‹Ð¹, Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ)
            pip install -U yt-dlp
            # --- ÐšÐžÐÐ•Ð¦ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ SAVIFY ---

            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
            mkdir -p logs
            mkdir -p Qobuz/Downloads
            
            echo "ðŸ” Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ musicbot..."
            chown -R musicbot:musicbot "$APP_DIR"

            echo "â™»ï¸ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ° musicbot..."
            systemctl daemon-reload
            systemctl restart musicbot.service

            echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"